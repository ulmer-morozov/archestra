name: Claude Pull Requests

on:
  workflow_call:
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

jobs:
  claude-pull-requests:
    name: Claude Pull Requests
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.pull_request.title, '[WIP]')
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0 # Need full history to compare with base branch
          persist-credentials: true # credentials are needed here as Claude will use them to read stuffs

      - name: Check PR diff size
        id: check_diff
        env:
          PR_BASE_REF: ${{ github.event.pull_request.base.ref }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          # Fetch the base branch to ensure we have it locally
          git fetch origin "$PR_BASE_REF"

          # Get the diff stats between the base and head
          LINES_CHANGED=$(git diff --shortstat "origin/$PR_BASE_REF...$PR_HEAD_SHA" | awk '{print $4 + $6}' || echo "0")

          echo "Lines changed: $LINES_CHANGED"
          echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT

          if [ "$LINES_CHANGED" -lt 500 ]; then
            echo "skip_claude=true" >> $GITHUB_OUTPUT
            echo "Skipping Claude review - PR has less than 500 lines changed"
          else
            echo "skip_claude=false" >> $GITHUB_OUTPUT
            echo "Running Claude review - PR has $LINES_CHANGED lines changed"
          fi

      - name: Run Claude Code
        if: steps.check_diff.outputs.skip_claude != 'true'
        uses: anthropics/claude-code-action@28f83620103c48a57093dcc2837eec89e036bb9f # v0.0.63
        with:
          # Dynamically set the secret based on the user who triggered the workflow
          # use their oauth token, since otherwise Anthropic will ban accounts for abuse :(
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Optional: Use sticky comments to make Claude reuse the same comment on subsequent pushes to the same PR
          use_sticky_comment: "true"

          # This will allow Claude to edit the PR description
          # See https://github.com/anthropics/claude-code-action/tree/main?tab=readme-ov-file#custom-tools
          allowed_tools: |
            Bash(gh pr edit:*)

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          model: "claude-opus-4-20250514"
          fallback_model: "claude-sonnet-4-20250514"

          # This is an optional setting that allows Claude to read CI results on PRs
          # See https://github.com/anthropics/claude-code-action?tab=readme-ov-file#additional-permissions-for-cicd-integration
          additional_permissions: |
            actions: read

          direct_prompt: |
            Be concise. Keep comments short and clear. Only elaborate if critical issues found.

            Tasks:
            1. Add PR description if missing
            2. Update CLAUDE.md if needed
            3. Quick review: bugs, security, performance (skip if none found)
